#! /bin/sh
systemctl stop avnav || echo "avnav not running"
systemctl stop check_parts || echo "check_parts not running"
systemctl stop check_wlan || echo "check_wlan not running"
rm -f /etc/init.d/avnav
rm -f /etc/init.d/check_wlan
rm -f /etc/init.d/check_parts
. /usr/lib/avnav/raspberry/raspi.version
systemctl daemon-reload
#systemctl enable avnav-check-wlan
#check-parts should not be necessary any more as we do not have small files - and it resizes anyway?!
#systemctl enable avnav-check-parts
systemctl enable avnav
echo stopping and disabling gpsd
systemctl disable gpsd || echo ' ' > /dev/null
systemctl stop gpsd || echo '' > /dev/null
CONFIG=/home/pi/avnav/data/avnav_server.xml
if [ -f $CONFIG ] ; then
    echo "migrating old config $CONFIG"
    if [ ! -f $CONFIG.save ] ; then
        cp $CONFIG $CONFIG.save
        chown pi $CONFIG.save
    fi
    sed -i -e 's? *shutdowncmd *= *"[^"]*"? ?' $CONFIG
    sed -i -e 's?settimecmd *= *"[^"]*"?settimecmd="/usr/lib/avnav/raspberry/settime.sh" shutdowncmd="/usr/lib/avnav/raspberry/shutdown.sh"?' $CONFIG
else
    echo "no old config $CONFIG found to migrate"
fi
grep "^ *FSCKFIX *= *yes" /etc/default/rcS > /dev/null || ( echo "configure FSCKFIX=yes"; echo 'FSCKFIX=yes' >> /etc/default/rcS)

#remove dhcp server ntp conf
DHCONF=/var/lib/ntp/ntp.conf.dhcp
if [ -f $DHCONF ] ; then
    echo "removing $DHCONF"
    rm -f $DHCONF
fi
[ ! -d var/lib/ntp/ ] && mkdir -p var/lib/ntp/
#a bit dirty trick to force ntpd to use our config file
cp /usr/lib/avnav/raspberry/ntp.conf $DHCONF
HOOK=/etc/dhcp/dhclient-exit-hooks.d/ntp
if [ -f $HOOK ] ; then
    echo "moving $HOOK into /etc/dhcp/save"
    [ ! -d /etc/dhcp/save ] && mkdir /etc/dhcp/save
    mv $HOOK /etc/dhcp/save
fi
#remove wlan0 config from /etc/network/interfaces
sed -i -e '/^iface *wlan0/,/^[^ ]/d' -e '/wlan0/d' /etc/network/interfaces

systemctl daemon-reload
systemctl restart dnsmasq
systemctl restart ntp
#systemctl start avnav-check-parts
systemctl restart avnav
#TODO:
#ntp setup
#sudo setup
exit 0