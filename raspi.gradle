
import java.text.SimpleDateFormat;
def taskgroup="avnav"

buildscript{
	repositories{
		mavenCentral()
	}
    dependencies{
        classpath 'com.netflix.nebula:gradle-ospackage-plugin:3.6.1'
    }
}

repositories{
	mavenCentral()
}

description="Raspberry specfic stuff for avnav"
apply plugin: 'java'

apply plugin: 'nebula.ospackage-base'

task pkgVersion<<{
    if (! project.hasProperty('packageVersion')){
        SimpleDateFormat f=new SimpleDateFormat('YYYYMMdd')
        ospackage.version f.format(new Date())
    }
    else{
        ospackage.version=packageVersion
    }
    println "package version $ospackage.version"
}

ospackage {
    //release='3'
    os = LINUX // only applied to RPM
    packageGroup='misc'
    requires 'avnav'
    requires 'parted'
    requires 'bc'
    requires 'hostapd'
    requires 'dnsmasq'
    packageName='avnav-raspi'
    user='root'
    into ('/usr/lib/avnav/raspberry') {
        from('raspberry'){
            fileMode 0755
            include 'check_parts'
            include 'check_wlan'
            include 'hostapd'
            include 'settime.sh'
            include 'shutdown.sh'
        }
        from('raspberry') {
            include 'avnav_server.xml'
            include 'hosts'
            fileMode 0644
        }
    }
    into('/usr/lib/systemd/system/avnav.service.d'){
        from('raspberry'){
            include "raspberry.conf"
        }
    }
    into('/usr/lib/systemd/system'){
        from('raspberry'){
            //include('avnav-check-wlan.service')
            include('avnav-check-parts.service')
        }
    }
    into('/etc/network/interfaces.d'){
        from('raspberry'){
            include('wlan0')
            include('wlan-av1')
        }
    }
    into('/etc/hostapd'){
        from('raspberry'){
            include('hostapd.conf')
        }
    }
    into('/etc'){
        from('raspberry'){
            include('iptables.ipv4.nat')
        }
    }
    into('/usr/sbin'){
        from('raspberry'){
            include('hostapd.edimax')
            fileMode 0755
        }
    }
    into('/etc/udev/rules.d'){
        from('raspberry'){
            include('010-avnav-net.rules')
        }
    }
    into('/etc/wpa_supplicant'){
        from('raspberry'){
            include('wpa_supplicant.conf')
        }
    }
    into('/etc/dnsmasq.d'){
        from('raspberry'){
            include('avnav-dnsmasq.conf')
        }
    }

    postInstall file('raspberry/postinstall')
    preInstall file('raspberry/preinstall')

}





task raspiDeb(type: Deb) {
    group taskgroup
    dependsOn pkgVersion
}


